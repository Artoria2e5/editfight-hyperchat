<!DOCTYPE html>
<html>

<head>
  <title>EditFight.com</title>
  <meta charset="utf-8">
  <meta content="initial-scale=1.0"
        name="viewport">
  <script src="//unpkg.com/vue/dist/vue.min.js"></script>
  <style>
    html {
      box-sizing: border-box;
      font-size: 16px;
      font-family: sans-serif;
      background-color: #f0f0f0;
      color: #555;
    }

    *, *:before, *:after {
      box-sizing: inherit;
      font-size: inherit;
      font-family: inherit;
      background-color: inherit;
      color: inherit;
      margin: 0;
      padding: 0;
    }

    h1, h2, h3, h4, h5, h6, p, ul, ol, li {
      margin: 1em 0;
    }

    h1 {
      font-size: 24px
    }

    h2 {
      margin: 1.5em 0;
    }

    li {
      list-style-position: inside;
      margin: 0.5em 0;
    }

    a {
      color: blue;
    }

    a:visited {
      color: purple;
    }

    a:hover {
      color: crimson;
    }

    .column {
      margin: 0 auto;
      width: 90%;
      max-width: 40em;
    }

    header {
      background-color: #ad4949;
    }

    header h1 {
      margin: 0;
      padding: 1em 0;
      font-weight: normal;
    }

    header a {
      color: white !important;
      text-decoration: none;
    }

    #tabbar, #tabbar li {
      margin: 0;
    }

    #subhead {
      background: white;
      padding: 1em 0;
    }

    #explain-button {
      cursor: pointer;
      text-decoration: underline;
      color: #ad4949;
    }

    main {
      margin-top: 2em;
    }

    #input {
      display: block;
      width: 100%;
      border: 0;
      border-bottom: 4px solid #ad4949;
      outline: none;
      -webkit-appearance: none;
    }

    .line {
      margin: 1em 0;
      background-color: white;
      padding: 1em;
      border-radius: 0.33em;
      border-bottom: 0.25em #e8e8e8 solid;
      font-family: serif;
      font-weight: bold;
    }

    #announcements {
      position: fixed;
      z-index: 9;
      top: 0;
      left: 1em;
      right: 1em;
      margin: 0;
      background: transparent;
    }

    .announcement {
      background: #fdfdc0;
      padding: 1em;
      border-radius: 0.25em;
      border: 1px solid #b3b372;
      margin-top: 1em;
    }

    .announcement-close {
      float: right;
      color: red;
      cursor: pointer;
      margin-left: 1em;
      margin-bottom: 1em;
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <div id="vue-app">

    <div id="announcements">
      <div class="announcement"
           v-for="announcement in announcements">
        <span class="announcement-close"
              v-on:click="closeAnnouncement(announcement)">[close]</span>
        <span>{{ announcement }}</span>
      </div>
    </div>

    <div id="sticky-header">
      <header>
        <section class="column">
          <h1>
            <a href="/">lines.editfight.com</a>
          </h1>
        </section>
      </header>

      <div id="subhead">
        <section class="column">
          <p id="explain-button"
             v-on:click="explain = !explain">
            What's all this then?
          </p>
          <div v-if="explain"
               id="explain-body">
            <h2>Hyper-real-time chat.</h2>
            <ol>
              <li>Everyone gets one textbox.</li>
              <li>Everyone can see everyone else's textbox.</li>
              <li>All changes are seen by everyone immediately.</li>
            </ol>
          </div>
        </section>
      </div>
    </div>

    <main>
      <section class="column">

        <div v-if="!connected">
          Connecting...
        </div>

        <div v-if="connected">
          <input v-focus
                 type="text"
                 id="input"
                 class="line"
                 autocapitalize="none"
                 v-model="myText"
                 v-on:input="updateText($event)"
                 v-bind:style="{ color: myColor }">
          <div class="line"
               v-for="line in lines"
               v-bind:style="{ color: line.color }">
            {{ line.text }}
          </div>
        </div>

      </section>
    </main>

  </div>

  <script>
    "use strict";

    window.WebSocket = window.WebSocket || window.MozWebSocket
    if (!window.WebSocket) {
      showAnnouncement("Your browser doesn't support this website. Please let me know what browser it is because I thought all browsers supported websockets at this point.")
      throw new Error('No websocket support.')
    }

    const connection = new WebSocket(`ws://${location.host}:4000`)

    Vue.directive('focus', {
      componentUpdated(el) {
        el.focus()
      }
    })

    const app = new Vue({
      el: '#vue-app',
      data: {
        explain: false,
        connected: false,
        myColor: 'black',
        myText: '',
        lines: [],
        announcements: [],
      },
      methods: {

        closeAnnouncement(ann) {
          const i = this.announcements.indexOf(ann)
          this.announcements.splice(i, 1)
        },

        updateText() {
          send({ text: app.myText })
        },
      }
    })

    connection.onopen = () => {
      app.connected = true
    }

    connection.onclose = (e) => {
      app.connected = false
      console.log('closing', e)
      showAnnouncement('Disconnected. Auto-refreshing in 3 seconds.')
      setTimeout(() => {
        window.location.reload(true)
      }, 3000)
    }

    connection.onerror = (error) => {
      console.log('erroring')
      // showAnnouncement("The server is probably down. Or maybe you're offline.")
    }

    const commands = {

      hash(hash) {
        app.myColor = colorForHash(hash)
      },

      initial(lines) {
        app.lines = []
        lines.forEach((line) => {
          app.lines.push({
            text: line.text,
            color: colorForHash(line.hash),
            uuid: line.uuid,
          })
        })
      },

      added(line) {
        app.lines.push(line)
      },

      removed(i) {
        app.lines.splice(i, 1)
      },

      update(json) {
        app.lines.find((line) => line.uuid === json.uuid).text = json.text
      },

      announcement(text) {
        showAnnouncement(text)
      },

    }

    connection.onmessage = (message) => {
      const json = JSON.parse(message.data)
      Object.entries(json).forEach(([key, value]) => {
        commands[key](value)
      })
    }

    function showAnnouncement(text) {
      app.announcements.push(text)
    }

    function colorForHash(hash) {
      const hue = hash % 180 + 180
      const sat = Math.abs(hash) % 50 + 30
      const light = Math.abs(hash) % 60 + 20
      return `hsl(${hue}, ${sat}%, ${light}%)`
    }

    function send(msg) {
      connection.send(JSON.stringify(msg))
    }
  </script>
</body>

</html>