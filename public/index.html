<!DOCTYPE html>
<html>

<head>
  <title>HyperChat.EditFight.com</title>
  <meta charset="utf-8">
  <meta content="initial-scale=1.0"
        name="viewport">
  <script src="//unpkg.com/vue/dist/vue.min.js"></script>
  <style>
    html {
      box-sizing: border-box;
      font-size: 16px;
      font-family: sans-serif;
      background-color: #f0f0f0;
      color: #555;
      height: 100%;
      min-height: 100%;
    }

    *,
    *:before,
    *:after {
      box-sizing: inherit;
      font-size: inherit;
      font-family: inherit;
      background-color: inherit;
      color: inherit;
      margin: 0;
      padding: 0;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    ul,
    ol,
    li {
      margin: 1em 0;
    }

    h1 {
      font-size: 24px
    }

    h2 {
      margin: 1.5em 0;
    }

    li {
      list-style-position: inside;
      margin: 0.5em 0;
    }

    a {
      color: blue;
    }

    a:visited {
      color: purple;
    }

    a:hover {
      color: crimson;
    }

    .column {
      margin: 0 auto;
      width: 90%;
      max-width: 40em;
    }

    header {
      background-color: #ad4949;
    }

    header h1 {
      margin: 0;
      padding: 1em 0;
      font-weight: normal;
    }

    header a {
      color: white !important;
      text-decoration: none;
    }

    #tabbar,
    #tabbar li {
      margin: 0;
    }

    #subhead {
      background: white;
      padding: 1em 0;
    }

    main {
      padding: 2em 0;
    }

    #input {
      display: block;
      width: 100%;
      border: 0;
      border-bottom: 4px solid #ad4949;
      outline: none;
      -webkit-appearance: none;
      resize: none;
    }

    .line-container {
      margin: 1em 0;
      display: flex;
    }

    .line-container>*:first-child {
      flex: 1 0;
    }

    .line-container>*:last-child {
      flex: 0 1;
    }

    .line {
      background-color: white;
      padding: 1em;
      border-radius: 0.33em;
      border-bottom: 0.25em #e8e8e8 solid;
      font-family: serif;
      font-weight: bold;
      white-space: pre-wrap;
      overflow: auto;
      max-height: 15em;
    }

    .line.admin {
      background-color: #fffedd;
      border-color: #E2E1B9 !important;
    }

    .upvote-button {
      margin-left: 1em;
      outline: none;
      border: 0;
      border-bottom: 3px solid #236d21;
      background: #5fc35d;
      color: white;
      padding: 0.25em 0.5em;
      border-radius: 0.25em;
      cursor: pointer;
    }

    .upvote-button:disabled {
      background: #ddd;
      border-bottom-color: #bbb;
    }

    #announcements {
      position: fixed;
      z-index: 9;
      top: 0;
      left: 1em;
      right: 1em;
      margin: 0;
      background: transparent;
    }

    .announcement {
      background: #fdfdc0;
      padding: 1em;
      border-radius: 0.25em;
      border: 1px solid #b3b372;
      margin-top: 1em;
    }

    .announcement-close {
      float: right;
      color: red;
      cursor: pointer;
      margin-left: 1em;
      margin-bottom: 1em;
      text-decoration: underline;
    }

    .indented {
      margin-left: 2ch;
    }

    #powers-section {
      font-family: monospace;
      margin: 0;
      padding: 1em;
      border-radius: 0.5em;
      background: #dadada;
      border-bottom: 4px solid #bbb;
    }

    #powers {
      display: block;
      width: 100%;
      border: 0;
      /* border-bottom: 4px solid #496cad; */
      outline: none;
      -webkit-appearance: none;
      resize: none;
      font-family: inherit;
    }

    #powers::-ms-placeholder {
      color: #ccc;
    }

    #powers::placeholder {
      color: #ccc;
    }

    #status {
      white-space: pre-wrap;
    }





    html.dark {
      height: 100%;
      background: #3c3c3c;
      color: #ccc;
    }

    html.dark #subhead {
      background-color: #2b2b2b;
    }

    html.dark a {
      color: #ffe1b1;
    }

    html.dark a:visited {
      color: #cba6f1;
    }

    html.dark a:hover {
      color: #a6f1c9;
    }

    html.dark .line {
      background: #2b2b2b;
      border-color: #191919;
    }

    html.dark #input {
      border-color: #270e0e;
    }





    html.dark .line.admin {
      background-color: #353410;
      border-color: #272608 !important;
    }

    html.dark .upvote-button {
      border-color: #0d500c;
      background: #2a6329;
      color: white;
    }

    html.dark .upvote-button:disabled {
      background: #505050;
      border-bottom-color: #333333;
    }

    html.dark .announcement {
      background: #98986e;
      color: #333;
      border-color: transparent;
    }

    html.dark .announcement-close {
      color: #7b0909;
    }

    html.dark #powers-section {
      background: #505050;
      border-color: #333333;
    }

    html.dark #powers::-ms-placeholder {
      color: #555;
    }

    html.dark #powers::placeholder {
      color: #555;
    }
  </style>
</head>

<body>

  <div id="vue-app">

    <div id="announcements">
      <div class="announcement"
           v-for="announcement in announcements">
        <span class="announcement-close"
              v-on:click="closeAnnouncement(announcement)">[close]</span>
        <span v-html="announcement"></span>
      </div>
    </div>

    <div id="sticky-header">
      <header>
        <section class="column">
          <h1>
            <a href="/">HyperChat.EditFight.com</a>
          </h1>
        </section>
      </header>

      <div id="subhead">
        <section class="column">
          <h2>Hyper-real-time chat.</h2>
          <p>&lambda; <a href="#"
               v-on:click.prevent="startChatting">Open your textbox.</a></p>
          <p><span v-html="showInstructions ? '&minus;' : '&plus;'"></span> <a href="#"
               v-on:click.prevent="showInstructions = !showInstructions">Instruction manual; v2.</a></p>
          <ol class="indented"
              v-if="showInstructions">
            <li>Your textbox starts at the bottom.</li>
            <li>Everyone can see everyone typing live.</li>
            <li>Lines are limited to <b>{{charLimit}}</b> characters.</li>
            <li>You can upvote someone every <b>{{upvoteLimit}}</b> seconds.</li>
            <li>There's an idle-timeout of <b>{{idleKickMinutes}} &times; $votes</b> minutes.</li>
          </ol>

          <p>&gt; <a href="#"
               v-on:click.prevent="toggleDarkMode">{{darkMode ? "Light Mode" : "Dark Mode"}}.</a></p>
          <p>&rarr; <a target="_blank"
               href="http://editfight.com/#chat">Send me feedback.</a></p>

          <p><b>{{count - lurkers}}</b> (<b>{{((1 - (lurkers / count)) * 100).toFixed(0) + '%'}}</b>) active; <b>{{lurkers}}</b>            idle</p>
        </section>
      </div>
    </div>

    <main>
      <section class="column">

        <div v-if="status"
             id="status">{{status}}</div>
        <div v-if="connected">
          <template v-for="line in lines">
            <template v-if="line.uuid === uuid">
              <div div
                   class="line-container">
                <textarea type="text"
                          id="input"
                          ref="myTextbox"
                          class="line"
                          autocapitalize="none"
                          v-model="myText"
                          v-on:input="updateText($event)"
                          v-bind:class="line.specialClass"
                          v-bind:style="{ color: myColor }"></textarea>
                <div>
                  <button class="upvote-button"
                          v-if="showNumbers"
                          disabled>{{ line.upvotes }}</button>
                </div>
              </div>

              <div id="powers-section"
                   v-if="powers">
                <input type="text"
                       id="powers"
                       placeholder="Command Line"
                       class="line"
                       v-model="myCommand"
                       v-on:keyup.13="tryCommand">
                <div class="indented">
                  <ul>
                    <li>color &lt;css-color-code&gt;</li>
                    <li>shownumbers</li>
                    <li>hidecheatmode</li>
                  </ul>
                  <p>More coming soon.</p>
                </div>
              </div>

            </template>
            <template v-else>
              <div div
                   class="line-container">
                <div class="line"
                     v-bind:class="line.specialClass"
                     v-bind:style="{ color: line.color }">{{ line.text }}</div>
                <div>
                  <button class="upvote-button"
                          v-bind:disabled="!canVote"
                          v-on:click.prevent="upvote(line.uuid)"><template v-if="showNumbers">{{ line.upvotes }}&nbsp;</template>&uarr;</button>
                </div>
              </div>
            </template>
          </template>
        </div>

      </section>
    </main>

  </div>

  <script>
    "use strict";

    if (window.location.hostname !== 'hyperchat.editfight.com' && window.location.hostname !== 'localhost') {
      window.location.href = 'http://hyperchat.editfight.com/'
      throw new Error('Redirecting.')
    }

    const app = new Vue({
      el: '#vue-app',
      data: {
        status: "Connecting...",
        startedChatting: false,
        idleKickMinutes: 0,
        upvoteLimit: 0,
        showNumbers: false,
        darkMode: false,
        showInstructions: false,
        canVote: true,
        charLimit: 'n',
        count: 0,
        connected: false,
        myColor: 'black',
        myText: '',
        lines: [],
        announcements: [],
        powers: false,
        myCommand: '',
      },

      computed: {

        lurkers() {
          return this.count - this.lines.length
        },

      },

      methods: {

        closeAnnouncement(ann) {
          const i = this.announcements.indexOf(ann)
          this.announcements.splice(i, 1)
        },

        updateText() {
          if (app.myText === 'POWER OVERWHELMING') {
            if (app.powers)
              return

            app.powers = true
            showAnnouncement("Cheat Mode: <b>Activated</b>")
          }

          app.myText = app.myText
            .substring(0, app.charLimit)

          send({ text: app.myText })
          resizeTextbox()
        },

        startChatting() {
          if (!app.startedChatting) {
            app.startedChatting = true
            send({ begin: true })

            app.lines.push(viewModelForModel({
              uuid: app.uuid,
            }))
          }

          Vue.nextTick(() => {
            resizeTextbox()
            app.$refs['myTextbox'][0].focus()
          })
        },

        upvote(uuid) {
          send({ upvote: uuid })
          app.canVote = false
          const delay = app.upvoteLimit * 1000
          setTimeout(() => app.canVote = true, delay)
        },

        tryCommand() {
          if (!app.myCommand) return

          let spaceLoc = app.myCommand.indexOf(' ')
          if (spaceLoc === -1)
            spaceLoc = app.myCommand.length
          else
            spaceLoc += 1

          const name = app.myCommand.substring(0, spaceLoc).trim()
          const args = app.myCommand.substring(spaceLoc).trim()
          const cmd = userCommands[name]

          if (cmd)
            cmd(args)
          else if (name)
            send({ unknownCommand: { name: name, args } })

          app.myCommand = ''
        },

        toggleDarkMode() {
          app.darkMode = !app.darkMode
          document.documentElement.classList.toggle('dark')
        },

      }
    })

    window.WebSocket = window.WebSocket || window.MozWebSocket
    if (!window.WebSocket) {
      app.status = "Your browser doesn't support this website.\n\nPlease let me know what browser it is because I thought all browsers supported websockets at this point."
      throw new Error('No websocket support.')
    }

    var connection = new WebSocket(`ws://${location.host}/app`)

    var userCommands = {

      color(color) {
        if (!color) return
        send({ color: color })
      },

      shownumbers() {
        app.showNumbers = true
      },

      hidecheatmode() {
        app.powers = false
        showAnnouncement("Cheat Mode: <b>Deactivated</b>")
      },

    }

    connection.onopen = () => {
      app.connected = true
      app.status = null
    }

    connection.onclose = (e) => {
      app.connected = false
      console.log('closing', e)
      showAnnouncement('Disconnected. Auto-refreshing for you.')
      setTimeout(() => {
        window.location.reload(true)
      }, 500)
    }

    connection.onerror = (error) => {
      console.log('erroring')
      app.status = "The server is probably down. Or maybe you're offline."
    }

    const commands = {

      admin(i) {
        app.lines[i].specialClass = { admin: true }
      },

      color(json) {
        if (json.uuid === app.uuid) {
          app.myColor = json.color
        }
        else {
          const line = app.lines.find((line) => line.uuid === json.uuid)
          line.color = json.color
        }
      },

      initial({ count, idleKickMinutes, upvoteLimit, lines, hash, uuid, charLimit }) {
        app.myColor = colorForHash(hash)
        app.charLimit = charLimit
        app.uuid = uuid
        app.upvoteLimit = upvoteLimit
        app.idleKickMinutes = idleKickMinutes
        app.count = count
        app.lines = lines.map(viewModelForModel)
      },

      joined() {
        app.count += 1
      },

      left() {
        app.count -= 1
      },

      added(line) {
        const viewModelLine = viewModelForModel(line)

        if (line.uuid === app.uuid) {
          const i = app.lines.findIndex((line) => line.uuid === app.uuid)
          app.lines[i] = viewModelLine
        }
        else {
          app.lines.push(viewModelLine)
        }

        resizeTextbox()
      },

      removed(i) {
        app.lines.splice(i, 1)
        resizeTextbox()
      },

      update(json) {
        const line = app.lines.find((line) => line.uuid === json.uuid)
        line.text = normalizeText(json.text)
      },

      announcement(text) {
        showAnnouncement(text)
      },

      moved(oldIndex) {
        const line = app.lines[oldIndex]
        const newIndex = oldIndex - 1
        const tmpLine = app.lines[newIndex]
        app.lines[newIndex] = line
        app.lines[oldIndex] = tmpLine

        line.upvotes += 1
        resizeTextbox()
      },

    }

    connection.onmessage = (message) => {
      const json = JSON.parse(message.data)
      Object.entries(json).forEach(([key, value]) => {
        commands[key](value)
      })
    }

    function showAnnouncement(text) {
      app.announcements.push(text)
    }

    function normalizeText(text) {
      return (text || '\n')
    }

    function viewModelForModel(line) {
      return {
        text: normalizeText(line.text),
        color: line.color ? line.color : colorForHash(line.hash),
        uuid: line.uuid,
        upvotes: line.upvotes,
        specialClass: { admin: line.admin },
      }
    }

    function colorForHash(hash) {
      const hue = hash % 360
      const sat = Math.abs(hash) % 30 + 5
      const light = Math.abs(hash) % 20 + 40
      return `hsl(${hue}, ${sat}%, ${light}%)`
    }

    function send(msg) {
      connection.send(JSON.stringify(msg))
    }

    function resize(textbox) {
      textbox.style.height = "1px"
      textbox.style.height = (textbox.scrollHeight + 4) + "px"
    }

    function resizeTextbox() {
      const textbox = app.$refs['myTextbox'][0]
      resize(textbox)
    }
  </script>
</body>

</html>